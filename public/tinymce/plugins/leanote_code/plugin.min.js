tinymce.PluginManager.add("leanote_code",function(e,t){function n(e){if(!e)return e;"object"==typeof e&&(e=$(e).html());return e.replace(/\<br *\/*\>/gi,"\n").replace(/<\/(p|li|div|ul|ol|hr)>/,"\n").replace(/(<([^>]+)>)/gi,"").replace(/\n\n/g,"\n")}function r(e){if(!e)return e;"object"==typeof e&&(e=$(e).html());return e.replace(/\n/g,"<br />")}function i(){var e=$("#editorContent").children(),t=e&&e.length>0?e[e.length-1]:null;t&&"P"==t.tagName||$("#editorContent").append('<p><br data-mce-bogus="1"></p>')}function o(e){if(!LEA.readOnly){s=tinymce.activeEditor;var t,o=s.selection.getNode(),a=s.selection.getContent(),l=LeaAce.isInAce(o),c=!1,d=!1;if(l){c=l[0];d=l[1]}$("#editorContent .toggle-raw").remove();var u='class="brush:'+e+'"';if(e&&"convert"!=e){c&&c.session.setMode("ace/mode/"+e);d||"PRE"!=o.nodeName||(d=$(o));if(d){var f=LeaAce.getPreBrush(d);d.removeClass(f).addClass("brush:"+e);return}}else if(e&&("BODY"==o.nodeName||"editorContent"==$(o).attr("id")))return;if(LeaAce.canAce()){var p=LeaAce.getAceId();LeaAce.disableAddHistory();if(c){var h=c.getValue();h=h.replace(/</g,"&lt;");h=h.replace(/>/g,"&gt;");h=h.replace(/\n/g,"<br />");d.replaceWith("<p>"+h+"</p>");c.destroy()}else{if("PRE"==o.nodeName){var d=$(o),h=d.html();h&&(h=h.replace(/\n/g,"<br />"));d.replaceWith("<p>"+h+"</p>");return}var t=a;if(!t&&("BODY"==o.nodeName||"editorContent"==$(o).attr("id")))return;if(t){t=n(t);s.insertContent('<pre id="'+p+'" '+u+">"+t+"</pre>")}else{t=n(o);$(o).replaceWith("<pre id='"+p+"'"+u+">"+t+"</pre>")}var c=LeaAce.initAce(p);if(c){c.focus();e&&"convert"!=e&&c.session.setMode("ace/mode/"+e);i()}}LeaAce.resetAddHistory()}else{"PRE"!=o.nodeName&&(o=$(o).closest("pre").get(0));if(o&&"PRE"==o.nodeName){var d=$(o),h=d.html();h&&(h=h.replace(/\n/g,"<br />"));d.replaceWith("<p>"+h+"</p>")}else{try{t=$.trim($(a).text())}catch(m){}t||(t=$.trim(a));var g=null,p=LeaAce.getAceId();if(t){t=r(t);g='<pre id="'+p+'" '+u+">"+t+"</pre>";s.insertContent(g)}else if(o){t=r(o);g='<pre id="'+p+'" '+u+">"+t+"</pre>";$(o).replaceWith(g)}else{g='<pre id="'+p+'" '+u+">"+t+"</pre>";s.insertContent(g)}g&&i()}}}}function a(){return function(){var t=this;e.on("nodeChange",function(){var n=null;try{var r=e.selection.getNode();"PRE"!=r.nodeName&&(r=$(r).closest("pre").get(0));if(r){var i=LeaAce.isInAce(r),o=!1,a=!1;if(i||"PRE"==r.nodeName){if(i){o=i[0];a=i[1]}else a=$(r);var s=LeaAce.getPreBrush(a);n=$.trim(s.split(":")[1]);t.diableValue("convert",!1)}else t.diableValue("convert",!0)}}catch(l){log(l)}"convert"!=n&&t.value(n)})}}var s=e;e.addButton("leanote_code",function(){var e=["Convert Code:convert","CSS:css","HTML:html","C/C++:c_cpp","Python:python","Shell:sh","Golang:golang","Rust:rust","diff:diff","xml:xml","ini:ini","yaml:yaml","Makefile:makefile","Dockerfile:dockerfile","Javascript:javascript","Java:java","PHP:php","C#:csharp","Ruby:ruby","Sql:sql"],t=[];for(var n in e){var r=e[n].split(":");t.push({text:r[0],value:r[1]})}return{type:"listbox",text:"Language",tooltip:"`ctrl/cmd+shift+c` toggle code",values:t,fixedWidth:!0,onselect:function(e){e.control.settings.value&&o(e.control.settings.value)},onPostRender:a(t)}});e.addButton("leanote_inline_code",{icon:"code",tooltip:"Inline Code",stateSelector:"code",onclick:function(){e.execCommand("mceToggleFormat",!1,"code")}});LeaAce.canAce()&&e.addButton("leanote_ace_pre",{icon:"ace-pre",tooltip:"Toggle ace with raw html",active:LeaAce.isAce===!1,onclick:function(){if(LeaAce.isAce===!1){this.active(!1);LeaAce.isAce=!0;LeaAce.initAceFromContent(e)}else{this.active(!0);LeaAce.allToPre(e);LeaAce.isAce=!1}}});s.addCommand("toggleCode",o);s.addShortcut("ctrl+shift+c","","toggleCode");s.addShortcut("meta+shift+c","","toggleCode");LeaAce.canAce()&&e.on("keydown",function(e){var t=LeaAce.nowIsInAce();if(t){setTimeout(function(){t[0].focus()});return!0}});s.on("keydown",function(e){var t=e.which?e.which:e.keyCode;if(9==t&&!e.shiftKey){var n=s.selection.getNode();if(n&&("LI"==n.nodeName||$(n.closest("li")).length>0))return!0;s.insertContent("&nbsp;&nbsp;&nbsp;&nbsp;");e.preventDefault();e.stopPropagation();return!1}})});