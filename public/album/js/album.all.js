function log(e){}function retIsOk(e){return!(!e||"object"!=typeof e||1!=e.Ok)}function getImageSize(e,t){function a(e,a){i.parentNode.removeChild(i),t({width:e,height:a})}var i=document.createElement("img");i.onload=function(){a(i.clientWidth,i.clientHeight)},i.onerror=function(){a()},i.src=e;var s=i.style;s.visibility="hidden",s.position="fixed",s.bottom=s.left=0,s.width=s.height="auto",document.body.appendChild(i)}function mdGetImgSrc(){return o.selectedImages&&o.selectedImages.length?o.selectedImages[0]:""}jQuery.fn.pagination=function(e,t){return t=jQuery.extend({items_per_page:10,num_display_entries:10,current_page:0,num_edge_entries:2,link_to:"#",prev_text:"Prev",next_text:"Next",ellipse_text:"...",prev_show_always:!0,next_show_always:!0,callback:function(){return!1}},t||{}),this.each(function(){function a(){return Math.ceil(e/t.items_per_page)}function i(){var e=Math.ceil(t.num_display_entries/2),i=a(),s=i-t.num_display_entries,r=n>e?Math.max(Math.min(n-e,s),0):0,l=n>e?Math.min(n+e,i):Math.min(t.num_display_entries,i);return[r,l]}function s(e,a){a.preventDefault(),n=e,r();var i=t.callback(e,l);return i||(a.stopPropagation?a.stopPropagation():a.cancelBubble=!0),i}function r(){l.empty();var e=i(),r=a(),o=function(e){return function(t){return s(e,t)}},d=function(e,a){e=e<0?0:e<r?e:r-1,a=jQuery.extend({text:e+1,classes:""},a||{});var i="";if(e==n){var s=jQuery("<span class='current'>"+a.text+"</span>");a.text!=t.prev_text&&a.text!=t.next_text&&(i='class="active"')}else var s=jQuery("<a>"+a.text+"</a>").bind("click",o(e)).attr("href",t.link_to.replace(/__id__/,e));a.classes&&s.addClass(a.classes);var d=$("<li "+i+"></li>").append(s);l.append(d)};if(t.prev_text&&(n>0||t.prev_show_always)&&d(n-1,{text:t.prev_text,classes:"prev"}),e[0]>0&&t.num_edge_entries>0){for(var c=Math.min(t.num_edge_entries,e[0]),u=0;u<c;u++)d(u);t.num_edge_entries<e[0]&&t.ellipse_text&&jQuery("<li><span>"+t.ellipse_text+"</span></li>").appendTo(l)}for(var u=e[0];u<e[1];u++)d(u);if(e[1]<r&&t.num_edge_entries>0){r-t.num_edge_entries>e[1]&&t.ellipse_text&&jQuery("<li><span>"+t.ellipse_text+"</span></li>").appendTo(l);for(var m=Math.max(r-t.num_edge_entries,e[1]),u=m;u<r;u++)d(u)}t.next_text&&(n<r-1||t.next_show_always)&&d(n+1,{text:t.next_text,classes:"next"})}var n=t.current_page;e=!e||e<0?1:e,t.items_per_page=!t.items_per_page||t.items_per_page<0?1:t.items_per_page;var l=jQuery(this);this.selectPage=function(e){s(e)},this.prevPage=function(){return n>0&&(s(n-1),!0)},this.nextPage=function(){return n<a()-1&&(s(n+1),!0)},r()})};var urlPrefix="",getMsg=parent.getMsg;getMsg||(getMsg=function(e){return e});var o={maxSelected:G.maxSelected,selectedZoneO:$("#preview"),previewO:$("#preview"),selectedImages:[],imageAttrs:{},pageNum:1,pagination:function(e){var t=this;$(".pagination").pagination(e,{items_per_page:G.perPageItems,prev_text:getMsg("Prev"),next_text:getMsg("Next"),callback:function(e){t.pageNum=e+1,t.renderImages($("#albumsForList").val(),t.pageNum,!1)}})},showMsg:function(e){$("#msg").html(e).css("display","inline"),setTimeout(function(){$("#msg").fadeOut()},2e3)},pageAddAlbum:function(e){var t='<option value="'+e.AlbumId+'">'+e.Name+"</option>";$("#albumsForUpload").append(t).val(e.AlbumId),$("#albumsForList").append(t)},pageUpdateAlbum:function(e,t){$('option[value="'+e+'"]').html(t)},processAlbum:function(){function e(){$("#addOrUpdateAlbumForm").is(":hidden")?($("#addOrUpdateAlbumForm").show(),$("#albumSelect").hide()):($("#addOrUpdateAlbumForm").hide(),$("#albumSelect").show())}var t=this,a=!0,i="";$("#renameAlbumBtn").click(function(){return(i=$("#albumsForUpload").val())?(e(),$("#addOrUpdateAlbumBtn").html(getMsg("Rename Album")),$("#albumName").val($("#albumsForUpload option:selected").html()).focus(),void(a=!1)):void alert(getMsg("Cannot rename default album"))}),$("#addAlbumBtn").click(function(){e(),$("#addOrUpdateAlbumBtn").html(getMsg("Add Album")),$("#albumName").val("").focus(),a=!0}),$("#cancelAlbumBtn").click(function(){e()}),$("#addOrUpdateAlbumBtn").click(function(){var s=$("#albumName").val();return s?void(a?$.get("/album/addAlbum",{name:s},function(a){"object"==typeof a&&""!=a.AlbumId?($("#albumName").val(""),t.showMsg(getMsg("Add Success!")),t.pageAddAlbum(a),setTimeout(function(){e()},200)):alert(getMsg("error"))}):$.get("/album/updateAlbum",{albumId:i,name:s},function(a){"boolean"==typeof a&&a?($("#albumName").val(""),t.showMsg(getMsg("Rename Success!")),t.pageUpdateAlbum(i,s),setTimeout(function(){e()},200)):alert(getMsg("error!"))})):void $("#albumName").focus()}),$("#deleteAlbumBtn").click(function(){var e=$("#albumsForUpload").val();return e?void $.get("/album/deleteAlbum",{albumId:e},function(a){"object"==typeof a&&1==a.Ok?(t.showMsg(getMsg("Delete Success!")),$("#albumsForUpload option[value='"+e+"']").remove(),$("#albumsForList").val()==e&&(t.needRefresh=!0),$("#albumsForList option[value='"+e+"']").remove()):alert(getMsg("This album has images, please delete it's images at first."))}):void alert(getMsg("Cannot delete default album"))})},renderAlbums:function(){var e=this;$.get("/album/getAlbums",function(t){if(t){var a="";for(var i in t){var s=t[i],r='<option value="'+s.AlbumId+'">'+s.Name+"</option>";a+=r}$("#albumsForUpload").append(a),$("#albumsForList").append(a);var n=$("#albumsForList").val();e.renderImages(n,1,!0)}})},imageMaskO:$("#imageMask"),noImagesO:$("#noImages"),loadingO:$("#loading"),loadingStart:function(){this.imageMaskO.is(":hidden")&&this.imageMaskO.css("opacity",.8).show(),this.noImagesO.hide(),this.loadingO.show()},loadingEnd:function(){this.imageMaskO.hide()},noImages:function(){this.imageMaskO.show().css("opacity",1),this.noImagesO.show(),this.loadingO.hide()},search:function(){var e=this,t=1;$("#key").on("keyup",function(){var a=++t,i=$(this).val(),s=$("#albumsForList").val();e.renderImages(s,1,!0,i,function(){return t==a})})},renderImages:function(e,t,a,i,s){var r=this;t||(t=1),r.loadingStart(),$.get("/file/getImages",{albumId:e,page:t,key:i},function(e){if(!e||!e.Count)return void r.noImages();r.loadingEnd();var t=e.List,i={};for(var s in r.selectedImages){var n=r.selectedImages[s];i[n]=!0}var l="";for(var s in t){var o=t[s],d="";if(""!=o.Path&&"/"==o.Path[0]&&(o.Path=o.Path.substr(1)),""!=o.Path&&"upload/"==o.Path.substr(0,7))var n=urlPrefix+"/"+o.Path;else var n="/api/file/getImage?fileId="+o.FileId;i[n]&&(d='class="selected"'),l+="<li "+d+">",l+='<a title="" href="javascript:;" class="a-img"><img  alt="" src="'+n+'" data-original="'+n+'" ></a>',l+='<div class="tools clearfix" data-id="'+o.FileId+'"><div class="file-title pull-left">'+o.Title+'</div><div class="pull-right"><a href="javascript:;" class="del" data-id="'+o.FileId+'"><span class="fa fa-trash"></span></a></div></div>',l+="</li>"}$("#imageList").html(l),a&&r.pagination(e.Count)})},initSelectedZones:function(){var e=this;num=this.maxSelected,e.previewO.html("");for(var t=1;t<=num;++t)e.previewO.append("<li>?</li>")},reRenderSelectedImages:function(e,t){for(var a=this,i=this.selectedZoneO.find("li"),s=this.selectedImages.length-1,r=0;r<this.maxSelected;++r){var n=i.eq(r);if(r>s)n.html("?");else{src=this.selectedImages[r];var l=a.imageAttrs[src],o="";l&&(l.width&&(o+=' data-width="'+l.width+'"'),l.height&&(o+=' data-height="'+l.height+'"'),l.title&&(o+=' data-title="'+l.title+'"')),n.html("<img "+o+' src="'+src+'" width="60"/><div class="tools"><a title="'+getMsg("click to remove this image")+'" href="javascript:;" class="del"><span class="fa fa-trash"></span></a></div>')}e?n.removeClass("selected"):t==src&&n.click()}},removeSelectedImage:function(e){var t=this,a=e.find("img").attr("src");for(var i in this.selectedImages)this.selectedImages[i]==a&&this.selectedImages.splice(i,1);this.reRenderSelectedImages(!0),t.clearAttrs()},addSelectedImage:function(e){if(this.maxSelected>1&&this.maxSelected<=this.selectedImages.length)return!1;if("object"==typeof e)var t=e.find("img").attr("src");else t=e.indexOf("http://")!=-1||e.indexOf("https://")!=-1?e:"/api/file/getImage?fileId="+e;return 1==this.maxSelected?($("#imageList li").removeClass("selected"),this.selectedImages=[t]):this.selectedImages.push(t),this.reRenderSelectedImages(!1,t),!0},initDataFromTinymce:function(){var e=this,t=top.LEAUI_DATAS,a="";if(t&&t.length>0){for(var i in t){var s=t[i];s.constrain=!0,a=s.src,e.selectedImages.push(s.src),e.imageAttrs[s.src]=s}e.reRenderSelectedImages(!1,a)}},init:function(){var e=this;e.processAlbum(),$("#albumsForList").change(function(){var t=$(this).val();e.renderImages(t,1,!0)}),$("#imageList").on("click","li",function(){$(this).hasClass("selected")?($(this).removeClass("selected"),e.removeSelectedImage($(this))):e.addSelectedImage($(this))&&$(this).addClass("selected")}),$("#imageList").on("click",".del",function(t){var a=this;if(t.stopPropagation(),confirm(getMsg("Are you sure to delete this image ?"))){var i=$(this).data("id");$.get("/file/deleteImage",{fileId:i},function(t){if(t){var i=$(a).closest("li");i.hasClass("selected")&&e.removeSelectedImage(i),$(a).closest("li").remove()}})}}),$("#imageList").on("click",".file-title",function(e){var t=this;if(e.stopPropagation(),!$(this).children().eq(0).is("input")){var a=$(t).parent().data("id"),i=$(this).text();$(this).html('<input type="text" value="'+i+'" />');var s=$(this).find("input");s.focus(),s.keydown(function(e){13==e.keyCode&&$(this).trigger("blur")}),s.blur(function(){var e=$(this).val();e?$.post("/file/updateImageTitle",{fileId:a,title:e}):e=i,$(t).html(e)})}}),$("#preview").on("click",".del",function(t){t.stopPropagation();var a=$(this).closest("li"),i=a.find("img").attr("src");e.removeSelectedImage(a),$("#imageList img").each(function(){var e=$(this).attr("src");i==e&&$(this).parent().parent().removeClass("selected")})}),$("#goAddImageBtn").click(function(){$("#albumsForUpload").val($("#albumsForList").val()),$("#myTab li:eq(1) a").tab("show")}),$("#myTab a").on("shown.bs.tab",function(t){t.preventDefault(),$(this).tab("show");var a=$(this).attr("href");e.needRefresh&&"#images"==a&&(setTimeout(function(){var t=$("#albumsForList").val(),a=$("#key").val();e.renderImages(t,e.pageNum,!0,a)},200),e.needRefresh=!1),"#url"==a&&$("#imageUrl").focus()}),$("#refresh").click(function(){var t=$("#albumsForList").val(),a=$("#key").val();e.renderImages(t,e.pageNum,!1,a)}),$("#addImageUrlBtn").click(function(t){t.preventDefault();var a=$.trim($("#imageUrl").val());return a?void getImageSize(a,function(t){return t.width&&t.height?($("#msgForUrl").hide(),$("#imageUrl").val(""),void e.addSelectedImage(a)):void $("#msgForUrl").show()}):void $("#imageUrl").focus()}),$("#preview").on("click","li",function(){$(this).hasClass("selected")||$(this).find("img").length&&($("#preview li").removeClass("selected"),$(this).addClass("selected"),e.initAttr($(this)))}),$("#attrTitle, #attrWidth, #attrHeight").on("keyup",function(){e.modifyAttr($(this))}),$("#attrConstrain").on("click",function(){e.modifyAttr($(this))}),e.search(),e.initSelectedZones(),e.initDataFromTinymce(),e.renderAlbums(),e.initUploader()},curSrc:"",curLi:null,attrTitleO:$("#attrTitle"),attrWidthO:$("#attrWidth"),attrHeightO:$("#attrHeight"),attrConstrainO:$("#attrConstrain"),clearAttrs:function(){var e=this;e.attrTitleO.val("").attr("disabled",!0),e.attrHeightO.val("").attr("disabled",!0),e.attrWidthO.val("").attr("disabled",!0),e.attrConstrainO.prop("checked",!1).attr("disabled",!0)},scale:function(e){var t=this,a=t.attrConstrainO.is(":checked"),i=+t.attrWidthO.val(),s=+t.attrHeightO.val();if(!isNaN(i)&&!isNaN(s)){var r=t.getCurAttrs(),n=r.preWidth||r.width,l=r.preHeight||r.height;a&&n&&l&&(e?(s=parseInt(i/n*l),t.attrHeightO.val(s)):(i=parseInt(s/l*n),t.attrWidthO.val(i)));var o={width:i,height:s};return o}},getCurAttrs:function(){var e=this;return e.imageAttrs[e.curSrc]},setCurDataAttrs:function(e){var t=this,a=t.curLi.find("img");a.attr("data-width",e.width),a.attr("data-height",e.height),a.attr("data-title",e.title),t.imageAttrs[t.curSrc]=e},modifyAttr:function(e){var t=this,a=e.attr("id"),i=e.val(),s=t.getCurAttrs();if(s){switch(a){case"attrConstrain":i=0,e.is(":checked")&&(i=1),s.constrain=i;break;case"attrTitle":s.title=i;break;case"attrWidth":$.extend(s,t.scale(!0));break;case"attrHeight":$.extend(s,t.scale(!1))}t.setCurDataAttrs(s)}},initAttr:function(e){function t(e){e=e||{},a.attrTitleO.val(e.title).attr("disabled",!1),a.attrWidthO.val(e.width).attr("disabled",!1),a.attrHeightO.val(e.height).attr("disabled",!1),a.attrConstrainO.attr("disabled",!1),e.constrain?a.attrConstrainO.prop("checked",!0):a.attrConstrainO.prop("checked",!1),a.setCurDataAttrs(e)}var a=this;"object"!=typeof e&&(e=$("#preview").find('img[src="'+e+'"]').parent());var i=e.find("img").attr("src");a.curSrc=i,a.curLi=e;var s=a.imageAttrs[i];s=s||{},s&&s.width&&s.height?t(s):getImageSize(i,function(e){return e.title=s.title||"",e.constrain=1,e.preWidth=e.width,e.preHeight=e.height,i!=a.curSrc?(a.imageAttrs[i]=e,void a.setCurDataAttrs(s)):void t(e)})},needRefresh:!1,uploadRefreshImageList:function(){var e=this,t=$("#albumsForList").val();t==$("#albumsForUpload").val()&&(e.needRefresh=!0)},initUploader:function(){function e(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" GB":e>=1e6?(e/1e6).toFixed(2)+" MB":(e/1e3).toFixed(2)+" KB"}var t=this,a=$("#upload ul");$("#drop a").click(function(){$(this).parent().find("input").click()}),$("#upload").fileupload({dataType:"json",pasteZone:"",acceptFileTypes:/(\.|\/)(gif|jpg|jpeg|png|jpe)$/i,dropZone:$("#drop"),formData:function(e){return[{name:"albumId",value:$("#albumsForUpload").val()}]},add:function(t,i){var s=i.files[0].size,r=+parent.GlobalConfigs.uploadImageSize||100;if("number"==typeof s&&s>1048576*r){var n=$('<li><div class="alert alert-danger"><a class="close" data-dismiss="alert">×</a></div></li>');return n.find("div").append("<b>Warning:</b> "+i.files[0].name+" <small>[<i>"+e(i.files[0].size)+"</i>] is bigger than "+r+"M</small> "),void n.appendTo(a)}var n=$('<li><div class="alert alert-info"><img class="loader" src="/public/album/images/ajax-loader.gif"> <a class="close" data-dismiss="alert">×</a></div></li>');n.find("div").append(i.files[0].name+" <small>[<i>"+e(i.files[0].size)+"</i>]</small>"),i.context=n.appendTo(a);i.submit()},done:function(a,i){if(1==i.result.Ok)i.context.remove(),t.addSelectedImage(i.result.Id),t.uploadRefreshImageList();else{i.context.empty(),alert(i.result.Msg);var s=$('<li><div class="alert alert-danger"><a class="close" data-dismiss="alert">×</a></div></li>');s.find("div").append("<b>"+getMsg("Error")+":</b> "+i.files[0].name+" <small>[<i>"+e(i.files[0].size)+"</i>]</small> "+i.result.Msg),i.context.append(s),setTimeout(function(e){return function(){e.remove()}}(s),3e3)}$("#upload-msg").scrollTop(1e3)},fail:function(t,a){a.context.empty();var i=$('<li><div class="alert alert-danger"><a class="close" data-dismiss="alert">×</a></div></li>');i.find("div").append("<b>Error:</b> "+a.files[0].name+" <small>[<i>"+e(a.files[0].size)+"</i>]</small> "+a.errorThrown),a.context.append(i),$("#upload-msg").scrollTop(1e3)}}),$(document).on("drop dragover",function(e){e.preventDefault()}),$(document).bind("dragover",function(e){var t=$("#drop"),a=window.dropZoneTimeout;a?clearTimeout(a):t.addClass("in");var i=!1,s=e.target;do{if(s===t[0]){i=!0;break}s=s.parentNode}while(null!=s);i?t.addClass("hover"):t.removeClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,t.removeClass("in hover")},100)})}};$(function(){o.init()});